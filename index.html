<?php
// Set the uploads directory
$uploadDir = __DIR__ . '/uploads/';

// Ensure the uploads directory exists
if (!is_dir($uploadDir)) {
    mkdir($uploadDir, 0777, true);
}

// Check if the request method is POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Retrieve the file name and content from the POST data
    $fileName = $_POST['fileName'] ?? '';
    $content = $_POST['content'] ?? '';

    // Ensure the file name is valid
    if (empty($fileName) || !preg_match('/^[a-zA-Z0-9_-]+\.php$/', $fileName)) {
        echo "Invalid file name.";
        http_response_code(400);
        exit;
    }

    // List of unsafe functions to check for
    $unsafeFunctions = ['exec', 'system', 'shell_exec', 'passthru', 'eval', 'assert', 'preg_replace', 'create_function'];

    // Scan the content for unsafe functions
    foreach ($unsafeFunctions as $function) {
        if (preg_match("/\b$function\b/i", $content)) {
            echo "The file contains potentially unsafe PHP code and cannot be uploaded.";
            http_response_code(400);
            exit;
        }
    }

    // Save the file content to the uploads directory
    $filePath = $uploadDir . basename($fileName);

    try {
        if (file_put_contents($filePath, $content) !== false) {
            // Return a success response
            echo "File successfully saved.";
            exit;
        } else {
            throw new Exception("Error writing file.");
        }
    } catch (Exception $e) {
        echo $e->getMessage();
        http_response_code(500);
        exit;
    }
}

// If not a POST request, return a 405 Method Not Allowed error
http_response_code(405);
echo "Method not allowed.";
?>